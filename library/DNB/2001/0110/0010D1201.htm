<html><!-- #BeginTemplate "/模板/internet.dwt" -->
<head>
<!-- #BeginEditable "doctitle" --> 
<title>让网站更具人性化——用ASP进行图片的上传与管理</title>
<!-- #EndEditable --> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="library/DNB/2001/%C4%A3%B0%E5/cpcw.css">
</head>

<body bgcolor="#FFFFFF" leftmargin="0" topmargin="2" marginwidth="0" marginheight="0">
<table width="770" border="1" cellspacing="0" cellpadding="1" align="center" bordercolorlight="#CCCCCC" bordercolordark="#FFFFFF">
  <tr> 
    <td width="148" align="center"> <iframe src="http://www.yesky.com/adj/html/cpcw-left.htm" width="140" height="60" frameborder="0" scrolling="no"></iframe> 
    </td>
    <td width="473" align="center" height="61"> 
      
    </td>
    <td align="center" width="149"><iframe src="http://www.yesky.com/adj/html/cpcw-right.htm" width="140" height="60" frameborder="0" scrolling="no"></iframe></td>
  </tr>
</table>
<table width="770" border="0" cellspacing="0" cellpadding="0" align="center" height="22" bgcolor="#3366CC">
  <tr> 
    <td width="40" align="center" height="20"><img src="http://www.lpzx.edu.cn/library/DNB/2001/%C4%A3%B0%E5/images/b1.gif" width="14" height="14"></td>
    <td width="583" height="20"> <span class="wj">| <a href="library/DNB/2001/Templates/wrapup.html" class="wj"><font color="#FFFFFF">综合报道</font></a> 
      | <a href="library/DNB/2001/Templates/software.html"><font color="#FFFFFF">软件世界</font></a> | <a href="library/DNB/2001/Templates/hardware.html"><font color="#FFFFFF">硬件周刊</font></a> 
      | <a href="library/DNB/2001/Templates/internet.html"><font color="#FFFFFF">互联网时代</font></a> 
      | <a href="library/DNB/2001/Templates/oa.html"><font color="#FFFFFF">OA专刊</font> </a>| <a href="library/DNB/2001/Templates/game.html"><font color="#FFFFFF">游戏广场</font></a> 
      | <a href="library/DNB/2001/Templates/maket.html"><font color="#FFFFFF">评测与市场</font></a> | <a href="library/DNB/2001/Templates/zt.html"><font color="#FFFFFF">专题版</font> 
      </a>| <a href="http://www.cpcw.com"><font color="#FFFFFF">首页</font></a></span></td>
    <td align="right" width="147" rowspan="2"><img src="http://www.lpzx.edu.cn/library/DNB/2001/%C4%A3%B0%E5/images/b2.gif" width="147" height="22"></td>
  </tr>
  <tr> 
    <td colspan="2" bgcolor="#FFCF96" height="2"></td>
  </tr>
</table>
<table width="770" border="0" cellspacing="0" cellpadding="0" align="center" bgcolor="#FF9900" height="48">
  <tr> 
    <td width="174" valign="bottom"><img src="http://www.lpzx.edu.cn/library/DNB/2001/%C4%A3%B0%E5/images/a1.gif" width="169" height="38"></td>
    <td width="448" class="nava"><span class="nava"><font color="#FFFFFF">严正声明<br>
      　　未经许可，任何商业网站或个人网站都不得提供《电脑报》电子版的浏览或下载！违者我们将追究其法律责任！</font></span></td>
    <td align="right" width="148" valign="top"><img src="http://www.lpzx.edu.cn/library/DNB/2001/%C4%A3%B0%E5/images/b3.gif" width="147" height="38"></td>
  </tr>
</table>
<table width="770" border="0" cellspacing="0" cellpadding="0" align="center" height="11">
  <tr> 
    <td width="169" rowspan="2" valign="top"><img src="http://www.lpzx.edu.cn/library/DNB/2001/%C4%A3%B0%E5/images/a2.gif" width="169" height="11"></td>
    <td width="460" height="2" bgcolor="#D77201"></td>
    <td width="141" rowspan="2" valign="top"><img src="http://www.lpzx.edu.cn/library/DNB/2001/%C4%A3%B0%E5/images/a3.gif" width="160" height="9"></td>
  </tr>
  <tr>
    <td width="460" height="9"></td>
  </tr>
</table>
<table width="770" border="0" cellspacing="0" cellpadding="0" align="center">
  <tr> 
    <td colspan="3" valign="top"> 
      <table width="430" border="0" cellspacing="0" cellpadding="0" align="center">
        <tr> 
          <td class="nava"><font color="#FF9900">你所在的位置：&gt;&gt;<a href="http://www.cpcw.com">《电脑报》电子版</a> 
            &gt;&gt;<a href="library/DNB/2001/Templates/index.html">2001年<!-- #BeginEditable "%B5%DA%BC%B8%C6%DA" -->{第10期}<!-- #EndEditable --> 
            </a>&gt;&gt;<a href="library/DNB/2001/Templates/internet.html">互联网时代</a></font></td>
        </tr>
      </table>
      <table width="430" border="0" cellspacing="0" cellpadding="0" align="center">
        <tr> 
          <td> 
            <div align="center"><!-- #BeginEditable "%CE%C4%D5%C2%B1%EA%CC%E2" -->{让网站更具人性化——用ASP进行图片的上传与管理}<!-- #EndEditable --></div>
          </td>
        </tr>
      </table>
      <table width="430" border="0" cellspacing="0" cellpadding="5" align="center">
        <tr> 
          <td> 
            <p><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->{ 网站上有一些主要内容来自于网络用户，比如求职招聘、婚介交友、虚拟社区等，它们都希望用户能够将相关图片上传到服务器上，并且可以动态地显示。这种功能将使网站内容更加丰富也更富于人性化。而关于图片的上传与管理也一直是ASP(Active 
              Server Pages)中的热点问题之一。许多文章和书籍对此都有过专门的介绍和讨论，给出了各种各样的解决办法，归结起来也不外乎两种：纯代码方式和组件方式。虽然纯代码方式看起来简单易行，但是一般来说这种方法是将图片直接存储到数据库的相关字段中，这样将对数据库乃至服务器都带来极大的负担，而且对于上传图片的管理也很不方便。因此这种方法并不适合于大型的应用；与之相比，组件方式虽然需要做取得和注册组件等额外的工作，但是却能够对上传的图片进行更丰富、更强大的处理，而且ASP对于AxtiveX组件也有着良好的支持，所以使用组件可以使我们获得更高的工作效率。下面我们就以一个免费组件为例来简单地介绍一下ASP中的图片上传与管理。<br>
              一、关于组件<br>
              这里首先介绍一下我们使用的这个免费组件：LyfUpload.dll。它来自“VB爱好者”网站(http://vbfans.yeah.net)。这个组件可以限制上传文件的大小和类型；支持多文件上传与文件的更名保存；在WIN98+PWS、NT+IIS3.0/4.0或者WIN2000+IIS5.0下都可以很好地工作，最重要的是可以免费使用。将下载的ZIP文件解压后，使用“regsvr32 
              lyfupload.dll”语句注册组件后，便可以在ASP中使用常规的方法使用了。另外，文件包中有详细的说明文档和相关例程。<br>
              二、设置数据库<br>
              真正的ASP站点一定会有后台数据库的支持，同样，我们也要把用户提交图片的相关信息保存到数据库中。上文已经提到，不能将图片支持存储到数据表中。解决的办法是设置一个“photo”字段，它的数据类型是普通的文本型，将字段的缺省值设为0，在此字段中只保存图片的路径和文件名，即在每一条记录里。如果用户没有上传图片则photo字段为0；如果已经上传图片，则显示路径和文件名。另外，如果将所有上传图片都保存到同一个目录下，则有可能发生重名现象，从而引发不能正确显示的错误。解决的办法是设置一个“userid”字段，其数据类型是自动编号，此字段将自动为每一个注册用户分配一个唯一的ID号作为用户标识。在真正接收图片之前利用组件将图片的文件名更改为userid字段中的ID号，然后再进行保存。这便可以保证用户与其上传的图片能够正确的关联。<br>
              三、用户上传界面的编写<br>
              为了接受用户的上传，我们需要编写两个ASP文件。一个是处理登录信息及给用户提供上传界面的文件，一个是处理和接收上传信息的文件。我们先介绍一下用户上传界面的文件，首先需要说明的是能够进入这个文件的用户应该是已经注册过的，否则此用户便没有ID号，所以在进入之前用户必须填写自己的用户名和密码，在此文件中也要检验用户名和密码的正确性。下面是此文件的源代码：<br>
              &lt;--#include file=&quot;dbconn.asp&quot;--&gt; '此包含文件是数据库的连接语句<br>
              &lt;% sql=&quot;select  from user where username='&quot; &amp; 
              Request&quot;user_name&quot; &amp; &quot;'&quot;<br>
              set Rs=conn.Executesql<br>
              if Request&quot;user_name&quot; =&quot;&quot; or Request&quot;pwd&quot; 
              =&quot;&quot; then<br>
              Response.Redirect &quot;memberin.htm&quot;<br>
              end if %&gt;<br>
              &lt;html&gt;<br>
              &lt;head&gt;<br>
              &lt;title&gt;会员图片上传&lt;/title&gt;<br>
              &lt;/head&gt;<br>
              &lt;body&gt;<br>
              &lt;% If Rs.Bof OR Rs.Eof Then<br>
              Response. Write &quot;&lt;html&gt;&lt;body&gt;&lt;center&gt;我们的数据库中没有查到你的用户名，请先注册新用户&lt;p&gt;&quot;<br>
              Response.Write &quot;&lt;a href='login.htm'&gt; 注册新用户 &lt;/a&gt;&quot;<br>
              Response.Write &quot;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;&quot;<br>
              Else<br>
              If trimRequest&quot;pwd&quot; &lt;&gt;Rs&quot;pwd&quot; Then<br>
              Response. Write &quot;&lt;html&gt;&lt;body&gt;&lt;center&gt;密码出错，请检查是否大小写不对。&lt;p&gt;&quot;<br>
              Response.Write &quot;&lt;a href='memberin.htm'&gt; 返回 &lt;/a&gt;&quot;<br>
              Response.Write &quot;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;&quot;<br>
              else<br>
              %&gt;<br>
              &lt;form name=&quot;frmUpload&quot; Method=&quot;Post&quot; Enctype=&quot;multipart/form-data&quot; 
              Action=&quot;upload.asp&quot; &gt;<br>
              &lt;table&gt;<br>
              &lt;tr&gt;<br>
              &lt;td &gt;选择照片&lt;/td&gt;<br>
              &lt;td &gt;&lt;input type=&quot;file&quot; name=&quot;file1&quot; 
              size=20 class=&quot;td&quot;&gt;&lt;/td&gt;<br>
              &lt;td &gt;&lt;INPUT TYPE=&quot;Submit&quot; VALUE=&quot;上传&quot;&gt;&lt;/ 
              td&gt;&lt;/tr&gt;<br>
              &lt;tr&gt;<br>
              &lt;td colspan=&quot;3&quot;&gt;<br>
              &lt;input type=&quot;hidden&quot; name=&quot;userid&quot; value=&quot;&lt;%=rs&quot;userid&quot; 
              %&gt;&quot;&gt;&lt;/td&gt;<br>
              &lt;/tr&gt;&lt;/table&gt;&lt;/form&gt;<br>
              &lt;% end if<br>
              end if<br>
              conn.Close<br>
              set conn=nothing %&gt;<br>
              &lt;/body&gt;&lt;/html&gt;<br>
              其中，表单域“file1”可以提供对话框让用户选择需要上传的图片；另外，我们设置了一个隐含的表单域“userid”读入此用户的ID号以便upload.asp文件使用。<br>
              四、upload.asp文件的编写<br>
              在upload.asp文件中我们将调用LyfUpload.dll组件来处理和接收上传的图片信息，并将图片更名后保存到photo字段中。下面是upload.asp的源代码：<br>
              &lt;--#include file=&quot;dbconn.asp&quot;--&gt;<br>
              &lt;html&gt;<br>
              &lt;head&gt;<br>
              &lt;title&gt;会员图片上传&lt;/title&gt;<br>
              &lt;/head&gt;<br>
              &lt;body&gt;<br>
              &lt;table&gt;<br>
              &lt;tr&gt;<br>
              &lt;td&gt;<br>
              &lt;% Set obj = Server.CreateObject&quot;LyfUpload.UploadFile&quot;<br>
              obj.maxsize=50000<br>
              obj.extname=&quot;gif jpg &quot;<br>
              txt = obj.request&quot;userid&quot;<br>
              ss=obj.SaveFile&quot;file1&quot; &quot;c\inetpub\wwwroot\photo&quot;obj.request&quot;userid&quot;<br>
              aa=obj.filetype&quot;file1&quot;<br>
              path=&quot;photo/&quot; &amp; txt<br>
              if ss= &quot;&quot; then<br>
              Response.Write &quot;请选择相应的文件&quot;<br>
              elseif ss= &quot;0&quot; then<br>
              Response.Write &quot;&lt;font size=4&gt;文件尺寸过大&lt;/font&gt;&quot;<br>
              else<br>
              Response.Write &quot;&lt;font size=4&gt;选择的文件已经上传到服务器！&lt;/font&gt;&quot;<br>
              Response.Write&quot;&lt;p&gt;文件名称：&quot; &amp; ss<br>
              Response.Write&quot;&lt;br&gt;文件格式：&quot; &amp; aa<br>
              Response.Write&quot;&lt;br&gt;文件大小：&quot; &amp; obj.FileSize<br>
              end if %&gt;<br>
              &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;<br>
              &lt;% Dim SQL<br>
              SQL = &quot;Update user &quot; &amp; &quot;Set &quot; &amp; &quot;photo=&quot;<br>
              SQL = SQL &amp; &quot;'&quot; &amp;path&amp; &quot;'&quot;<br>
              SQL = SQL &amp; &quot; where userid=&quot; &amp; txt<br>
              Conn.Execute SQL<br>
              conn.Close<br>
              set conn=nothing %&gt;<br>
              &lt;/body&gt;<br>
              &lt;/html&gt;<br>
              其中“obj.maxsiz” 与“obj.extname”分别规定了上传图片的大小和类型；“ss=obj.SaveFile&quot;file1&quot; 
              &quot; c\inetpub\wwwroot\photo&quot;obj.request&quot;userid&quot; 
              ”的意思是将用户选择的图片更名为其ID号然后保存到主目录下的Photo目录里；最后的那一部分ASP语句是将图片的路径和文件名写入到数据库的photo字段中。<br>
              五、图片的显示<br>
              在需要显示图片的.asp文件中写入这样的代码：<br>
              &lt;--#include file=&quot;dbconn.asp&quot;--&gt;<br>
              &lt;% if rs&quot;photo&quot; &lt;&gt;&quot;0&quot; then%&gt;<br>
              &lt;img src=&quot;photo/&lt;%=rs&quot;photo&quot; %&gt;&quot; width=&quot;250&quot; 
              height=&quot;320&quot; border=&quot;2&quot;&gt;<br>
              &lt;% else<br>
              Response.Write &quot;没有照片&quot;<br>
              end if %&gt;<br>
              需要说明的只有一点，就是应在代码中对图片的长宽加以规定，即以统一的尺寸来显示图片，这样才不至于破坏整体页面显示。<br>
              到此我们已经完成了图片的上传、接收和显示，实际上，不仅仅是图片，其他可以上传的文件也可做类似的处理。另外在实际应用中，我们还能够依靠组件和数据库的强大功能作更为丰富的设计。如果你对此有什么问题或要求可以通过Swjin@21cn.com和我联系。}<!-- #EndEditable --></p>
          </td>
        </tr>
      </table>
      <br>
      <br>
      <br>
    </td>
  </tr>
</table>
<table width="770" border="0" cellspacing="0" cellpadding="0" align="center" height="4" bgcolor="#FF9900">
  <tr> 
    <td width="161" bgcolor="#99CCFF"> </td>
    <td width="610" bgcolor="#FF9900"></td>
  </tr>
</table>
<table width="770" border="0" cellspacing="0" cellpadding="0" align="center">
  <tr> 
    <td> 
      <div align="center"><a href="bill/index.html" target="_blank"></a><a href="hdong/gao.htm" target="_blank"> 
        欢迎投稿 </a> | <a href="bill/index.html" target="_blank">广告联系</a>| <a href="serve/dnbjs.htm" target="_blank">关于我们</a>| 
        <a href="maillist/index.html" target="_blank">电子杂志</a>| <a href="hdong/zaopin.html" target="_blank">加入我们</a>| 
        <a href="hdong/xinsi.html" target="_blank">隐私条款</a></div>
    </td>
  </tr>
</table>
<table width="770" border="0" cellspacing="0" cellpadding="0" align="center">
  <tr> 
    <td> 
      <div align="center"><span class="nava"><font color="#000000" face="Arial, Helvetica, sans-serif"> 
        Copyright (C) 2000 Yesky.com, All Rights Reserved </font><font color="#000000"><br> 
        版权所有　 <font face="Arial, Helvetica, sans-serif"> Yesky </font><br> <a href="mailto:webmaster@yesky.com"> 
        如有意见请与我们联系 </a></font></span></div>
    </td>
  </tr>
</table>
</body>
<!-- #EndTemplate --></html>
